---
title: "Fourtier_cypripedium"
author: "Galadriel"
format: html
editor: visual
---

# Chargement des packages

```{r}
library(tidyverse)
library(MASS)
library(ade4)
library(ggalluvial)

```

# Ouverture des tableaux de données

```{r}
recouvrement <- read.csv("data/raw/Recouvrement VF.csv",sep = ";")
unique(recouvrement$Site)

verification <- read.csv("data/raw/detections_individuelles_verifsTC+LD_18dec.csv", sep = ";")
#Problème d'espace à régler pour verification
unique(verification$site)
verification$site <- trimws(verification$site)
unique(verification$site)

data_original <- read.csv("data/raw/Taille et phéno verif LD.csv", sep = ";")
unique(data_original$site)

experience <- read.csv("data/raw/Experience_des_observateurs_VF.csv", sep = ";")
experience$sexe <- c("m","f","m","m","m","f","m","m","m","f","f","f","f","m","f","m","m","m","m","m","f","f","f","m","f","m","f","m","f","f","f","m","f","f","m")


```

#Analyse tableau recouvrements végétaux
###Pour chaque strate de recouvrement

***Strate muscilagineuse***

```{r}
#| echo: false
ggplot(recouvrement, aes(x = Quadrat, y = S_muscinale, color = Site))+
  geom_line()

```

***Strate herbacéee***

```{r}
#| echo: false
ggplot(recouvrement, aes(x = Quadrat, y = S_herbacee, color = Site))+
  geom_line()

```

***Strate arbustive basse***

```{r}
#| echo: false
ggplot(recouvrement, aes(x = Quadrat, y = S_arbustive_basse, color = Site))+
  geom_line()

```

***Strate arbustive haute***

```{r}
#| echo: false
ggplot(recouvrement, aes(x = Quadrat, y = S_arbustive_haute, color = Site))+
  geom_line()

```

***Strate arborescente***

```{r}
#| echo: false
ggplot(recouvrement, aes(x = Quadrat, y = S_arborescente, color = Site))+
  geom_line()
```

###Transformation strates en facteur

```{r}
recouvrement_par_strate <- recouvrement %>%
  pivot_longer(
    cols = c(-Site, -Quadrat, -ID_Quadrat, starts_with("S_")),
    names_to = "Strate",
    values_to = "Recouvrement"
  ) %>% 
  arrange(Strate)
  
```

####Visualisation des données 
#####Pour chaque site

***Combe Michaut***

```{r}
#| echo: false
recouvrement_par_strate %>% 
  filter(Site == "Combe Michaut") %>%
  ggplot(aes(x = factor(Quadrat), y = Recouvrement, color = Strate))+
  geom_point(position= "dodge") 

```

***Val Clavin***

```{r}
#| echo: false
recouvrement_par_strate %>% 
  filter(Site == "Val Clavin") %>%
  ggplot(aes(x = factor(Quadrat), y = Recouvrement, color = Strate))+
  geom_point(position= "dodge") 

```

***Vigne au Renard***

```{r}
#| echo: false
recouvrement_par_strate %>% 
  filter(Site == "Vigne au Renard") %>%
  ggplot(aes(x = factor(Quadrat), y = Recouvrement, color = Strate))+
  geom_point(position= "dodge") 

```

***Tete cendree haut***

```{r}
#| echo: false
recouvrement_par_strate %>% 
  filter(Site == "Tete cendree haut") %>%
  ggplot(aes(x = factor(Quadrat), y = Recouvrement, color = Strate))+
  geom_point(position= "dodge") 

```

#####Pour tous les sites
######Boxplot

```{r}
#| echo: false
ggplot(recouvrement_par_strate, aes(x = Strate, y = Recouvrement, color = Site))+
  geom_boxplot(position= "dodge") 

```

######AFD

```{r}
afd_recouvrement<-lda(Site~S_muscinale      +S_herbacee+S_arbustive_basse+S_arbustive_haute+S_arborescente   , data = recouvrement)

#on centre et norme les données
newdata<-as.data.frame(scale(recouvrement[,4:8])) 
names(newdata)
attach(recouvrement)
afd2<-lda(Site~S_muscinale      +S_herbacee+S_arbustive_basse+S_arbustive_haute+S_arborescente   , data = newdata)
afd2
plot(afd2)
manova <- manova(as.matrix(recouvrement[,4:8])~Site)
summary(manova, "Pillai")
summary(manova, "Wilks")

pred<-predict(afd2)
names(pred)
table(Site,pred$class)

#- Validation par jacknife en utilisant CV=T

afd2= lda(Site~S_muscinale      +S_herbacee+S_arbustive_basse+S_arbustive_haute+S_arborescente   , data = newdata, CV=TRUE)
names(afd2)
table(Site, afd2$class)

afd3=discrimin(dudi.pca(recouvrement[,4:8],scannf=F, nf = 3),factor(Site)) # se base sur une ACP centrée réduite et permet d'avoir des coéfficients standardisés 
names(afd3)
afd3$eig # interpréter les ratios variabilité intergroupes/variabilité intragroupe
sqrt(afd3$eig/(1+afd3$eig))

# NB : la fonction discrimin () est différente de LDA : réalise une ACP sur les barycentres des groupes de l'ACP initial. 

s.arrow(afd3$fa) # projection des variables sur les fonctions discriminantes = coef standardisés

s.class(afd3$li, factor(Site)) # projection des individus regroupés en fonction des groupes d'appartendance

rand=rtest(afd3,1000) # MANOVA non paramétrique (test de Pillai non paramétrique)
plot(rand)

```


#Analyse tableau vérification

```{r}
ggplot(verification, aes(x = juv, fill = site))+
  geom_bar(position = "dodge") +
  facet_wrap(~ session)+
  labs(x = "Présence des juvéniles", y = "Nombre d'occurences")
```

```{r}
ggplot(verification, aes(x = non_fleuri, fill = site))+
  geom_bar(position = "dodge") +
  facet_wrap(~ session)+
  labs(x = "Présence des non fleuris", y = "Nombre d'occurences")
```

```{r}
ggplot(verification, aes(x = fleur, fill = site))+
  geom_bar(position = "dodge") +
  facet_wrap(~ session)+
  labs(x = "Présence des fleurs", y = "Nombre d'occurences")
```


```{r}
ggplot(verification, aes(x = fleurs_fanees, fill = site))+
  geom_bar(position = "dodge") +
  facet_wrap(~ session)+
  labs(x = "Présence des fleurs fanées", y = "Nombre d'occurences")
```

```{r}
ggplot(verification, aes(x = fruit, fill = site))+
  geom_bar(position = "dodge") +
  facet_wrap(~ session)+
  labs(x = "Présence des fruits", y = "Nombre d'occurences")
```

```{r}
ggplot(verification, aes(x = adequation, fill = site))+
  geom_bar(position = "dodge") +
  facet_wrap(~ session)+
  labs(x = "Adéquation des observations avec le contrôleur", y = "Nombre d'occurences")
```

```{r}
ggplot(verification, aes(x = adequation, fill = observateur))+
  geom_boxplot(position = "dodge")+
  labs(x = "Adéquation des observations avec le contrôleur", y = "Observateur")
```

##Transformation phenologie en facteur
```{r}
verification2 <- verification %>% 
  pivot_longer(
    cols = c(juv, non_fleuri, fleur, fleurs_fanees, fruit),
    names_to = "phenologie",
    values_to = "presence"
  )

desired_order <- c("juv", "non_fleuri", "fleur", "fleurs_fanees", "fruit")
verification2$phenologie <- factor(verification2$phenologie,
                                   levels = desired_order)

```

###Analyses phénologie
```{r}
ggplot(verification2, aes(x = presence, fill = site))+
  geom_bar(position = "dodge")+
  facet_grid(session~phenologie)


```


```{r}
verification2 %>% 
  filter(presence == 1) %>% 
ggplot(aes(x = presence, fill = site))+
  geom_bar(position = "dodge")+
  facet_grid(session~phenologie)


```
###Analyse adéquation
```{r}
verification3 <- verification %>% 
  group_by(observateur) %>% 
  count(adequation) %>% 
  pivot_wider(
    names_from = adequation,
    values_from = n,
    names_glue = "{ifelse(adequation == 1, 'id_valide', 'id_fausse')}"
  ) %>% 
  replace_na(list(id_fausse = 0,
                  id_valide = 0)) %>% 
    mutate(tx_erreur = id_fausse / (id_valide + id_fausse),
           id_total = id_fausse + id_valide)

#Deux observateurs avec adéquation NA
verification %>% 
  filter(is.na(adequation))

ggplot(data = verification3, aes(x = tx_erreur, y = id_total, color = ))+
  geom_point()
cor.test(verification3$tx_erreur, verification3$id_total)
cor.test(verification3$tx_erreur, verification3$id_total, method = "spearman")

```
####Taux d'erreur par observateur

```{r}
ggplot(verification3, aes(x = tx_erreur, y = observateur)) +
  geom_segment(aes(x = 0, xend = tx_erreur, y = observateur, yend = observateur), color = "grey70") +
  geom_point(size = 4, color = "tomato") +
  labs(x = "Taux d'erreur", y = "Observateur") +
  theme_minimal()

ggplot(verification3, aes(x = tx_erreur, y = observateur)) +
  geom_segment(aes(x = 0, xend = tx_erreur,
                   y = observateur, yend = observateur),
               color = "grey70") +
  geom_point(aes(size = id_total), color = "tomato") +
  geom_text(aes(label = id_total), 
            nudge_x = 0.02,
            size = 2) +
  scale_size_continuous(name = "Nombre d'observations")+
  labs(x = "Taux d'erreur", y = "Observateur") +
  theme_minimal()

```

####Taux d'erreur par observateur en fonction du site

```{r}
verification4 <- verification %>% 
  left_join(verification3, by = "observateur")

ggplot(data = verification4, aes(x = tx_erreur, y = id_total))+
  geom_point()+
  facet_wrap(~site)
```

####Taux d'erreur par site

```{r}
verification5 <- verification %>% 
  group_by(site) %>% 
  count(adequation) %>% 
  pivot_wider(
    names_from = adequation,
    values_from = n,
    names_glue = "{ifelse(adequation == 1, 'id_valide', 'id_fausse')}"
  ) %>% 
  replace_na(list(id_fausse = 0,
                  id_valide = 0)) %>% 
    mutate(tx_erreur = id_fausse / (id_valide + id_fausse),
           id_total = id_fausse + id_valide)

ggplot(data = verification5, aes(x = tx_erreur, y=id_total, color = site))+
  geom_point()

```

```{r}
verification6 <- verification %>% 
  group_by(site, numero_quadrat) %>% 
  count(adequation) %>% 
  pivot_wider(
    names_from = adequation,
    values_from = n,
    names_glue = "{ifelse(adequation == 1, 'id_valide', 'id_fausse')}"
  ) %>% 
  replace_na(list(id_fausse = 0,
                  id_valide = 0)) %>% 
    mutate(tx_erreur = id_fausse / (id_valide + id_fausse),
           id_total = id_fausse + id_valide)

ggplot(data = verification6, aes(x = tx_erreur, y=id_total))+
  geom_point()+
  facet_wrap(~site)

```

####Taux d'erreur par observateur en fonction des sessions
```{r}
verification7 <- verification %>% 
  group_by(observateur, session) %>% 
  count(adequation) %>% 
  pivot_wider(
    names_from = adequation,
    values_from = n,
    names_glue = "{ifelse(adequation == 1, 'id_valide', 'id_fausse')}"
  ) %>% 
  replace_na(list(id_fausse = 0,
                  id_valide = 0)) %>% 
    mutate(tx_erreur = id_fausse / (id_valide + id_fausse),
           id_total = id_fausse + id_valide)


ggplot(verification7, aes(x = tx_erreur, y = observateur)) +
  geom_segment(aes(x = 0, xend = tx_erreur,
                   y = observateur, yend = observateur),
               color = "grey70") +
  geom_point(aes(size = id_total), color = "tomato") +
  geom_text(aes(label = id_total), 
            nudge_x = 0.02,
            size = 2) +
  scale_size_continuous(name = "Nombre d'observations")+
  labs(x = "Taux d'erreur", y = "Observateur") +
  facet_wrap(~session)


ggplot(data = verification7, aes(x = session, y = tx_erreur))+
  geom_line(aes(color=observateur))


```

####Taux d'erreur comparé à autonotation
```{r}
experience <- experience %>%
  mutate(score_moyen = rowMeans(across(A:E)))

experience <- experience %>%
  mutate(score_moyen = rowMeans(across(A:E)))
experience <- experience %>%
  mutate(score_moyen = rowMeans(across(A:E), na.rm = TRUE))

# Tri du plus compétent au moins compétent
experience %>%
  arrange(desc(score_moyen))

# Poids de fiabilité (normalisé entre 0 et 1)
experience <- experience %>%
  mutate(fiabilite = score_moyen / 10,
         risque_erreur = 1 - fiabilite)

experience <- experience %>%
  rowwise() %>%
  mutate(ecart_type = sd(c_across(A:E))) %>%
  ungroup()

experience <- experience %>%
  arrange(desc(risque_erreur)) %>%
  mutate(ID.observateur = factor(ID.observateur, levels = ID.observateur))


ggplot(experience, aes(x = ID.observateur, y = risque_erreur, fill = sexe)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("f" = "red", "m" = "blue")) +
  theme_minimal() +
  labs(title = "Risque d’erreur estimé par observateur",
       x = "Observateur", y = "Risque d’erreur (1 - fiabilité)")+geom_errorbar(
         aes(
           ymin = risque_erreur - (ecart_type/10),
           ymax = risque_erreur + (ecart_type/10)
         ),
         width = 0.2,
         linewidth = 0.6
       )



```


#Analyse tableau Taille et phéno verif LD
```{r}
transition_pheno <- data_original %>% 
  dplyr::select(ID_ind, phenoS1, phenoS2, phenoS3)

trans_12 <- transition_pheno %>%
  filter(!is.na(phenoS1), !is.na(phenoS2)) %>%
  count(from = phenoS1, to = phenoS2)

trans_23 <- transition_pheno %>%
  filter(!is.na(phenoS2), !is.na(phenoS3)) %>%
  count(from = phenoS2, to = phenoS3)

transition_pheno2 <- data_original %>% 
  dplyr::select(site, ID_ind, phenoS1, phenoS2, phenoS3)

transition_pheno3 <- transition_pheno2 %>% 
  pivot_longer(
    cols = c(phenoS1, phenoS2, phenoS3),
    names_to = "session",
    values_to = "phenologie"
  )

ggplot(transition_pheno3,
       aes(x = session,
           stratum = phenologie,
           alluvium = ID_ind,
           fill = phenologie)) +
  geom_flow(alpha = 0.2,  color = "black", linewidth = 0.1) +
  geom_stratum() +
  scale_x_discrete(breaks = c(1, 2, 3),
                     labels = c("Session 1", "Session 2", "Session 3")) +
  labs(
    x = "Session",
    y = "Number of individuals",
    fill = "Phenology",
    title = "Phenological transitions by individual"
  ) +
  facet_wrap(~site)

```

#Analyse proba de détection
```{r}

#ajout information session à l'ID individuel####
#pour tableau vérification des observateurs
verification2<- verification %>% 
  mutate(id_ind_fin = paste(ID_ind, session, sep = ".")) %>% 
  dplyr::select(id_ind_fin, everything())
#pour tableau des évaluateurs
##mettre stade phéno en ligne et non en colonne 
data_original2 <- data_original %>%
  dplyr::select(-tailleS1, -tailleS2, -tailleS3, -nbfleurs, -nbfruits, -predation) %>% 
  pivot_longer(
    cols = c(phenoS1, phenoS2, phenoS3),
    names_to = "session",
    values_to = "phenologie_verif"
  )%>% 
   mutate(session = case_when(
    session == "phenoS1" ~ 1,
    session == "phenoS2" ~ 2,
    session == "phenoS3" ~ 3
  )
   ) %>% 
  mutate(phenologie_verif
         = case_when(
    phenologie_verif == "j" ~ "juv",
    phenologie_verif == "nf" ~ "non_fleuri",
    phenologie_verif == "f" ~ "fleur",
    phenologie_verif == "ff" ~ "fleurs_fanees",
    phenologie_verif == "F" ~"fruit"
  ))

##mettre taille en ligne et non en colonne
data_original3 <- data_original %>% 
  dplyr::select(tailleS1, tailleS2, tailleS3) %>% 
  pivot_longer(
    cols = c(tailleS1, tailleS2, tailleS3),
    names_to = "session",
    values_to = "taille"
  ) %>% 
   mutate(session = case_when(
    session == "tailleS1" ~ 1,
    session == "tailleS2" ~ 2,
    session == "tailleS3" ~ 3
  )
   )

#enlever session car déjà présent sur autre data frame
data_original3 <- data_original3 %>% 
  dplyr::select(-session)

#ajout des deux tableaux + enlever lignes sans info  à cause d'observation d'un individu à partir de session 2 ou 3
data_original4 <- cbind(data_original2, data_original3) %>% 
  filter(!is.na(taille)) #enlever lignes avec pas d'infos

#vérifier si manque des informations par rapport à phénologie
data_original4 %>% 
  filter(is.na(phenologie_verif))

#ajout variable individuelle complète
data_original_obs <- data_original4 %>% 
  mutate(id_ind_fin = paste(ID_ind, session, sep = ".")) %>% 
  dplyr::select(id_ind_fin, everything())

#prendre en compte stade phéno observé par utilisateur
verification3 <- verification2 %>% 
  pivot_longer(
    cols = c(juv, non_fleuri, fleur, fleurs_fanees, fruit),
    names_to = "phenologie",
    values_to = "presence"
  )  
  
#garder seulement st phéno observé par utilisateur
verification_obs <- verification3 %>% 
  filter(presence == 1)
  
#Vérifier nb individus
str(unique(verification_obs$id_ind_fin))
str(unique(data_original_obs$id_ind_fin))
str(data_original_obs$id_ind_fin)
str(verification_obs$id_ind_fin)
#à priori 66 individus jamais vus par observateurs

#extraire liste de tous les individus
nb_individu <- data.frame(id_ind_fin = data_original_obs$id_ind_fin)

#extraire liste individus dans test de détection
nb_ind_obs <- data.frame(id_ind_fin = unique(verification_obs$id_ind_fin))

#individus manquants
nb_individu_manquant <- nb_individu %>% 
  anti_join(nb_ind_obs, by = "id_ind_fin")

#reprendre données originales sur les valeurs manquantes
nb_individu_manquant_original <- data_original_obs %>% 
  semi_join(nb_individu_manquant, by = "id_ind_fin") 
  

#joindre à ces données manquantes les valeurs du tableau observateur
nb_individu_manquant_final <- nb_individu_manquant_original %>% 
  left_join(verification_obs, by = "id_ind_fin") %>% 
  dplyr::select(-ends_with(".y")) %>% 
  rename_with(~ sub("\\.x$", "", .x), ends_with(".x"))

#Joindre au fichier original les informations des évaluateurs
data_verification_original <- verification_obs %>% 
  left_join(data_original_obs, by = "id_ind_fin") %>% 
  dplyr::select(-ends_with(".y")) %>% 
  rename_with(~ sub("\\.x$", "", .x), ends_with(".x"))

#mettre les colomnes dans le bon ordre
nb_individu_manquant_final <- nb_individu_manquant_final %>% 
  dplyr::select(id_ind_fin, session, site, date, numero_quadrat, ID_quadrat, marquage, ID_ind, observateur, adequation, phenologie, presence, quadrat, phenologie_verif, taille)

#joindre ces données manquantes à tableau observateurs
tab_detection <- rbind(data_verification_original, nb_individu_manquant_final)

#créer nouvelle valeur adéquation
tab_detection <- tab_detection %>% 
  mutate(adequation_reel = if_else(
    phenologie == phenologie_verif, 1, 0
  ),
  comparaison_adequation = if_else(
    adequation_reel==adequation, 1, 0
  )
  )

#Taux d'erreur dans note d'adéquation
sum(tab_detection$comparaison_adequation == 0, na.rm = T) / nrow(tab_detection)

#vérifier nombre d'observateurs par session et par quadrat
nb_verif_quadrat <- verification %>% 
  group_by(session, site, numero_quadrat) %>% 
  count()

nb_obs_quadrat <- tab_detection %>% 
  group_by(session, site, numero_quadrat) %>% 
  count()

```



