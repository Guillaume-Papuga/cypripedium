---
title: "Fourtier_cypripedium"
author: "Galadriel"
format: html
editor: visual
---

# Chargement des packages

```{r}
library(tidyverse)
library(MASS)
library(ade4)
```

# Ouverture des tableaux de données

```{r}
recouvrement <- read.csv("data/raw/Recouvrement VF.csv",sep = ";")

verification <- read.csv("data/raw/detections_individuelles_verifsTC+LD_18dec.csv", sep = ";")
#Problème d'espace à régler pour verification
unique(verification$site)
verification$site <- trimws(verification$site)
unique(verification$site)

```

#Analyse tableau recouvrements végétaux
###Pour chaque strate de recouvrement

***Strate muscilagineuse***

```{r}
#| echo: false
ggplot(recouvrement, aes(x = Quadrat, y = S_muscinale, color = Site))+
  geom_line()

```

***Strate herbacéee***

```{r}
#| echo: false
ggplot(recouvrement, aes(x = Quadrat, y = S_herbacee, color = Site))+
  geom_line()

```

***Strate arbustive basse***

```{r}
#| echo: false
ggplot(recouvrement, aes(x = Quadrat, y = S_arbustive_basse, color = Site))+
  geom_line()

```

***Strate arbustive haute***

```{r}
#| echo: false
ggplot(recouvrement, aes(x = Quadrat, y = S_arbustive_haute, color = Site))+
  geom_line()

```

***Strate arborescente***

```{r}
#| echo: false
ggplot(recouvrement, aes(x = Quadrat, y = S_arborescente, color = Site))+
  geom_line()
```

###Transformation strates en facteur

```{r}
recouvrement_par_strate <- recouvrement %>%
  pivot_longer(
    cols = c(-Site, -Quadrat, -ID_Quadrat, starts_with("S_")),
    names_to = "Strate",
    values_to = "Recouvrement"
  ) %>% 
  arrange(Strate)
  
```

####Visualisation des données 
#####Pour chaque site

***Combe Michaut***

```{r}
#| echo: false
recouvrement_par_strate %>% 
  filter(Site == "Combe Michaut") %>%
  ggplot(aes(x = factor(Quadrat), y = Recouvrement, color = Strate))+
  geom_point(position= "dodge") 

```

***Val Clavin***

```{r}
#| echo: false
recouvrement_par_strate %>% 
  filter(Site == "Val Clavin") %>%
  ggplot(aes(x = factor(Quadrat), y = Recouvrement, color = Strate))+
  geom_point(position= "dodge") 

```

***Vigne au Renard***

```{r}
#| echo: false
recouvrement_par_strate %>% 
  filter(Site == "Vigne au Renard") %>%
  ggplot(aes(x = factor(Quadrat), y = Recouvrement, color = Strate))+
  geom_point(position= "dodge") 

```

***Tete cendree haut***

```{r}
#| echo: false
recouvrement_par_strate %>% 
  filter(Site == "Tete cendree haut") %>%
  ggplot(aes(x = factor(Quadrat), y = Recouvrement, color = Strate))+
  geom_point(position= "dodge") 

```

#####Pour tous les sites
######Boxplot

```{r}
#| echo: false
ggplot(recouvrement_par_strate, aes(x = Strate, y = Recouvrement, color = Site))+
  geom_boxplot(position= "dodge") 

```

######AFD

```{r}
afd_recouvrement<-lda(Site~S_muscinale      +S_herbacee+S_arbustive_basse+S_arbustive_haute+S_arborescente   , data = recouvrement)

#on centre et norme les données
newdata<-as.data.frame(scale(recouvrement[,4:8])) 
names(newdata)
attach(recouvrement)
afd2<-lda(Site~S_muscinale      +S_herbacee+S_arbustive_basse+S_arbustive_haute+S_arborescente   , data = newdata)
afd2
plot(afd2)
manova <- manova(as.matrix(recouvrement[,4:8])~Site)
summary(manova, "Pillai")
summary(manova, "Wilks")

pred<-predict(afd2)
names(pred)
table(Site,pred$class)

#- Validation par jacknife en utilisant CV=T

afd2= lda(Site~S_muscinale      +S_herbacee+S_arbustive_basse+S_arbustive_haute+S_arborescente   , data = newdata, CV=TRUE)
names(afd2)
table(Site, afd2$class)

afd3=discrimin(dudi.pca(recouvrement[,4:8],scannf=F, nf = 3),factor(Site)) # se base sur une ACP centrée réduite et permet d'avoir des coéfficients standardisés 
names(afd3)
afd3$eig # interpréter les ratios variabilité intergroupes/variabilité intragroupe
sqrt(afd3$eig/(1+afd3$eig))

# NB : la fonction discrimin () est différente de LDA : réalise une ACP sur les barycentres des groupes de l'ACP initial. 

s.arrow(afd3$fa) # projection des variables sur les fonctions discriminantes = coef standardisés

s.class(afd3$li, factor(Site)) # projection des individus regroupés en fonction des groupes d'appartendance

rand=rtest(afd3,1000) # MANOVA non paramétrique (test de Pillai non paramétrique)
plot(rand)

```


#Analyse tableau vérification

```{r}
ggplot(verification, aes(x = juv, fill = site))+
  geom_bar(position = "dodge") +
  facet_wrap(~ session)+
  labs(x = "Présence des juvéniles", y = "Nombre d'occurences")
```

```{r}
ggplot(verification, aes(x = non_fleuri, fill = site))+
  geom_bar(position = "dodge") +
  facet_wrap(~ session)+
  labs(x = "Présence des non fleuris", y = "Nombre d'occurences")
```

```{r}
ggplot(verification, aes(x = fleur, fill = site))+
  geom_bar(position = "dodge") +
  facet_wrap(~ session)+
  labs(x = "Présence des fleurs", y = "Nombre d'occurences")
```


```{r}
ggplot(verification, aes(x = fleurs_fanees, fill = site))+
  geom_bar(position = "dodge") +
  facet_wrap(~ session)+
  labs(x = "Présence des fleurs fanées", y = "Nombre d'occurences")
```

```{r}
ggplot(verification, aes(x = fruit, fill = site))+
  geom_bar(position = "dodge") +
  facet_wrap(~ session)+
  labs(x = "Présence des fruits", y = "Nombre d'occurences")
```

```{r}
ggplot(verification, aes(x = adequation, fill = site))+
  geom_bar(position = "dodge") +
  facet_wrap(~ session)+
  labs(x = "Adéquation des observations avec le contrôleur", y = "Nombre d'occurences")
```

```{r}
ggplot(verification, aes(x = adequation, fill = observateur))+
  geom_boxplot(position = "dodge")+
  labs(x = "Adéquation des observations avec le contrôleur", y = "Observateur")
```

##Transformation phenologie en facteur
```{r}
verification2 <- verification %>% 
  pivot_longer(
    cols = c(juv, non_fleuri, fleur, fleurs_fanees, fruit),
    names_to = "phenologie",
    values_to = "presence"
  )

desired_order <- c("juv", "non_fleuri", "fleur", "fleurs_fanees", "fruit")
verification2$phenologie <- factor(verification2$phenologie,
                                   levels = desired_order)

```

###Analyses phénologie
```{r}
ggplot(verification2, aes(x = presence, fill = site))+
  geom_bar(position = "dodge")+
  facet_grid(session~phenologie)


```

```{r}
verification2 %>% 
  filter(presence == 1) %>% 
ggplot(aes(x = presence, fill = site))+
  geom_bar(position = "dodge")+
  facet_grid(session~phenologie)


```
###Analyse adéquation
```{r}
verification3 <- verification %>% 
  group_by(observateur) %>% 
  count(adequation) %>% 
  pivot_wider(
    names_from = adequation,
    values_from = n,
    names_glue = "{ifelse(adequation == 1, 'id_valide', 'id_fausse')}"
  ) %>% 
  replace_na(list(id_fausse = 0,
                  id_valide = 0)) %>% 
    mutate(tx_erreur = id_fausse / (id_valide + id_fausse),
           id_total = id_fausse + id_valide)

#Deux observateurs avec adéquation NA
verification %>% 
  filter(is.na(adequation))

ggplot(data = verification3, aes(x = tx_erreur, y = id_total, color = ))+
  geom_point()
cor.test(verification3$tx_erreur, verification3$id_total)
cor.test(verification3$tx_erreur, verification3$id_total, method = "spearman")

```
####Taux d'erreur par observateur

```{r}
ggplot(verification3, aes(x = tx_erreur, y = observateur)) +
  geom_segment(aes(x = 0, xend = tx_erreur, y = observateur, yend = observateur), color = "grey70") +
  geom_point(size = 4, color = "tomato") +
  labs(x = "Taux d'erreur", y = "Observateur") +
  theme_minimal()

ggplot(verification3, aes(x = tx_erreur, y = observateur)) +
  geom_segment(aes(x = 0, xend = tx_erreur,
                   y = observateur, yend = observateur),
               color = "grey70") +
  geom_point(aes(size = id_total), color = "tomato") +
  geom_text(aes(label = id_total), 
            nudge_x = 0.02,
            size = 2) +
  scale_size_continuous(name = "Nombre d'observations")+
  labs(x = "Taux d'erreur", y = "Observateur") +
  theme_minimal()

```

####Taux d'erreur par observateur en fonction du site

```{r}
verification4 <- verification %>% 
  left_join(verification3, by = "observateur")

ggplot(data = verification4, aes(x = tx_erreur, y = id_total))+
  geom_point()+
  facet_wrap(~site)
```

####Taux d'erreur par site

```{r}
verification5 <- verification %>% 
  group_by(site) %>% 
  count(adequation) %>% 
  pivot_wider(
    names_from = adequation,
    values_from = n,
    names_glue = "{ifelse(adequation == 1, 'id_valide', 'id_fausse')}"
  ) %>% 
  replace_na(list(id_fausse = 0,
                  id_valide = 0)) %>% 
    mutate(tx_erreur = id_fausse / (id_valide + id_fausse),
           id_total = id_fausse + id_valide)

ggplot(data = verification5, aes(x = tx_erreur, y=id_total, color = site))+
  geom_point()

```

```{r}
verification6 <- verification %>% 
  group_by(site, numero_quadrat) %>% 
  count(adequation) %>% 
  pivot_wider(
    names_from = adequation,
    values_from = n,
    names_glue = "{ifelse(adequation == 1, 'id_valide', 'id_fausse')}"
  ) %>% 
  replace_na(list(id_fausse = 0,
                  id_valide = 0)) %>% 
    mutate(tx_erreur = id_fausse / (id_valide + id_fausse),
           id_total = id_fausse + id_valide)

ggplot(data = verification6, aes(x = tx_erreur, y=id_total))+
  geom_point()+
  facet_wrap(~site)

```


