"0","### Session 1-2 ----"
"0",""
"0","# -------------------------------"
"0","# 1. Charger les données"
"0","# -------------------------------"
"0","data <- data_original"
"0",""
"0","# -------------------------------"
"0","# 2. Préparer les données phénologiques (sessions 1 et 2)"
"0","# -------------------------------"
"0","phenology_codes <- c(""j"" = 1, ""nf"" = 2, ""f"" = 3, ""ff"" = 4)"
"0",""
"0","phenology_data_numeric <- data %>%"
"0","  dplyr::select(ID_ind, phenoS1, phenoS2) %>%"
"0","  mutate("
"0","    phenoS1 = as.character(phenology_codes[phenoS1]),"
"0","    phenoS2 = as.character(phenology_codes[phenoS2])"
"0","  ) %>%"
"0","  # Supprimer les individus avec NA dans phenoS1 ou phenoS2"
"0","  filter(!is.na(phenoS1) & !is.na(phenoS2))"
"0",""
"0","# -------------------------------"
"0","# 3. Calcul empirique des transitions 1 → 2"
"0","# -------------------------------"
"0","phenology_long <- phenology_data_numeric %>%"
"0","  pivot_longer(cols = c(phenoS1, phenoS2),"
"0","               names_to = ""session"","
"0","               values_to = ""state"") %>%"
"0","  mutate(session = as.integer(gsub(""phenoS"", """", session)))"
"0",""
"0","# Transitions successives"
"0","transitions <- phenology_long %>%"
"0","  group_by(ID_ind) %>%"
"0","  arrange(session) %>%"
"0","  mutate(next_state = lead(state)) %>%"
"0","  filter(!is.na(next_state)) %>%"
"0","  count(state, next_state) %>%"
"0","  group_by(state) %>%"
"0","  mutate(prob = n / sum(n))"
"0",""
"0","# Créer la matrice 5x5"
"0","num_states <- 4"
"0","states <- c(""j"",""nf"",""f"",""ff"")"
"0","Psi_matrix <- matrix(0, nrow=num_states, ncol=num_states, dimnames = list(states, states))"
"0",""
"0","for(i in 1:num_states){"
"0","  for(j in 1:num_states){"
"0","    val <- transitions %>% filter(state == i, next_state == j) %>% pull(prob)"
"0","    if(length(val) > 0) Psi_matrix[i,j] <- mean(val)"
"0","  }"
"0","}"
"0",""
"0","# Normalisation par ligne"
"0","Psi_matrix_norm <- Psi_matrix / rowSums(Psi_matrix)"
"0",""
"0","# -------------------------------"
"0","# 4. Visualisation des transitions avec DiagrammeR"
"0","# -------------------------------"
"0","dot_code <- ""digraph pheno_transitions { "
"0","  rankdir=LR;"
"0","  node [shape=circle, style=filled, color=lightblue, fontname=Helvetica];"
"0","  j; nf; f; ff;"
"0",""""
"0",""
"0","for(i in 1:num_states){"
"0","  for(j in 1:num_states){"
"0","    prob <- Psi_matrix_norm[i,j]"
"0","    if(!is.na(prob) && prob > 0){"
"0","      dot_code <- paste0(dot_code, states[i], "" -> "", states[j], "
"0","                         "" [label=\"""", round(prob, 2), ""\""];\n"")"
"0","    }"
"0","  }"
"0","}"
"0",""
"0","dot_code <- paste0(dot_code, ""}"")"
"0","grViz(dot_code)"
